{% extends "base.html" %}

{% block title %}Manage Warnings{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="card-title mb-0">Manage Warnings</h2>
                <a href="{{ url_for('add_warning') }}" class="btn btn-primary">
                    <i class="fas fa-exclamation-triangle me-2"></i>Issue New Warning
                </a>
            </div>
            <p class="text-muted mb-4">View, filter, and manage staff warnings.</p>

            {# Filter and Search Section #}
            <div class="p-4 rounded-3 mb-4" style="background-color: #f8f9fa;">
                <h4 class="mb-3">Filter Warnings</h4>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="filter_staff" class="form-label">Staff Member:</label>
                        <select class="form-select" id="filter_staff">
                            <option value="all">All Staff</option>
                            {% for user in staff_users %}
                                <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="filter_manager" class="form-label">Issued By Manager:</label>
                        <select class="form-select" id="filter_manager">
                            <option value="all">All Managers</option>
                            {% for user in manager_users %}
                                <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="filter_severity" class="form-label">Severity:</label>
                        <select class="form-select" id="filter_severity">
                            <option value="all">All Severities</option>
                            <option value="Minor">Minor</option>
                            <option value="Major">Major</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="filter_status" class="form-label">Status:</label>
                        <select class="form-select" id="filter_status">
                            <option value="all">All Statuses</option>
                            <option value="Active">Active</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Expired">Expired</option>
                        </select>
                    </div>
                    <div class="col-12 d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" id="clear_filters_btn" class="btn btn-outline-secondary"><i class="fas fa-filter-slash me-2"></i>Clear Filters</button>
                    </div>
                </div>
            </div>

            {% if warnings %}
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle" id="warningsTable">
                    <thead class="table-dark">
                        <tr>
                            <th data-sort-by="staff_name">Staff Member <i class="fas fa-sort float-end"></i></th>
                            <th data-sort-by="issued_by">Issued By <i class="fas fa-sort float-end"></i></th>
                            <th data-sort-by="date_issued">Date Issued <i class="fas fa-sort float-end"></i></th>
                            <th>Reason</th>
                            <th data-sort-by="severity">Severity <i class="fas fa-sort float-end"></i></th>
                            <th data-sort-by="status">Status <i class="fas fa-sort float-end"></i></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for warning in warnings %}
                        <tr class="warning-row"
                            data-staff-id="{{ warning.user_id }}"
                            data-issued-by-id="{{ warning.issued_by_id }}"
                            data-severity="{{ warning.severity | lower }}"
                            data-status="{{ warning.status | lower }}"
                            data-date-issued="{{ warning.date_issued.isoformat() }}"
                            data-staff-name="{{ warning.user.full_name | lower }}"
                            data-issued-by-name="{{ warning.issued_by.full_name | lower }}"
                            data-severity-order="{% if warning.severity == 'Critical' %}3{% elif warning.severity == 'Major' %}2{% else %}1{% endif %}"
                            data-status-order="{% if warning.status == 'Active' %}1{% elif warning.status == 'Resolved' %}2{% else %}3{% endif %}"
                            >
                            <td class="fw-bold">{{ warning.user.full_name }}</td>
                            <td>{{ warning.issued_by.full_name }}</td>
                            <td>{{ warning.date_issued.strftime('%Y-%m-%d') }}</td>
                            <td><small>{{ warning.reason | truncate(100, true) }}</small></td>
                            <td>
                                <span class="badge {% if warning.severity == 'Critical' %}bg-danger{% elif warning.severity == 'Major' %}bg-warning text-dark{% else %}bg-info text-dark{% endif %}">
                                    {{ warning.severity }}
                                </span>
                            </td>
                            <td>
                                <span class="badge {% if warning.status == 'Active' %}bg-primary{% elif warning.status == 'Resolved' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ warning.status }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-2">
                                    <a href="{{ url_for('edit_warning', warning_id=warning.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
                                    {% if warning.status == 'Active' %}
                                    <form action="{{ url_for('resolve_warning', warning_id=warning.id) }}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Are you sure you want to mark this warning as resolved?')">Resolve</button>
                                    </form>
                                    {% endif %}
                                    {% if current_user.has_role('general_manager') or current_user.has_role('system_admin') %}
                                    <form action="{{ url_for('delete_warning', warning_id=warning.id) }}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this warning? This action cannot be undone.')">Delete</button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center">No warnings have been recorded yet.</p>
            {% endif %}

        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterStaff = document.getElementById('filter_staff');
    const filterManager = document.getElementById('filter_manager');
    const filterSeverity = document.getElementById('filter_severity');
    const filterStatus = document.getElementById('filter_status');
    const clearFiltersBtn = document.getElementById('clear_filters_btn');
    const warningsTable = document.getElementById('warningsTable');
    const tableBody = warningsTable ? warningsTable.querySelector('tbody') : null;
    let allWarningRows = []; // Store original DOM elements

    if (tableBody) {
        allWarningRows = Array.from(tableBody.querySelectorAll('.warning-row')).map(row => {
            return {
                element: row,
                staffId: row.dataset.staffId,
                issuedById: row.dataset.issuedById,
                severity: row.dataset.severity, // lowercase
                status: row.dataset.status,     // lowercase
                dateIssued: row.dataset.dateIssued, // ISO format
                staffName: row.dataset.staffName,
                issuedByName: row.dataset.issuedByName,
                severityOrder: parseInt(row.dataset.severityOrder, 10), // For sorting
                statusOrder: parseInt(row.dataset.statusOrder, 10)     // For sorting
            };
        });
    }

    let currentSortColumn = 'date_issued'; // Default sort
    let currentSortDirection = 'desc';     // Default sort

    function applyFiltersAndSort() {
        let filteredAndSortedRows = [...allWarningRows]; // Start with a copy

        const selectedStaffId = filterStaff.value;
        const selectedManagerId = filterManager.value;
        const selectedSeverity = filterSeverity.value;
        const selectedStatus = filterStatus.value;

        // Apply Filters
        filteredAndSortedRows = filteredAndSortedRows.filter(warning => {
            const staffMatch = selectedStaffId === 'all' || warning.staffId === selectedStaffId;
            const managerMatch = selectedManagerId === 'all' || warning.issuedById === selectedManagerId;
            const severityMatch = selectedSeverity === 'all' || warning.severity === selectedSeverity;
            const statusMatch = selectedStatus === 'all' || warning.status === selectedStatus;
            return staffMatch && managerMatch && severityMatch && statusMatch;
        });

        // Apply Sorting
        filteredAndSortedRows.sort((a, b) => {
            let valA, valB;
            if (currentSortColumn === 'date_issued') {
                valA = new Date(a.dateIssued);
                valB = new Date(b.dateIssued);
            } else if (currentSortColumn === 'severity') {
                valA = a.severityOrder;
                valB = b.severityOrder;
            } else if (currentSortColumn === 'status') {
                valA = a.statusOrder;
                valB = b.statusOrder;
            } else if (currentSortColumn === 'staff_name') {
                valA = a.staffName;
                valB = b.staffName;
            } else if (currentSortColumn === 'issued_by') {
                valA = a.issuedByName;
                valB = b.issuedByName;
            }

            let comparison = 0;
            if (valA > valB) { comparison = 1; }
            else if (valA < valB) { comparison = -1; }

            return currentSortDirection === 'asc' ? comparison : comparison * -1;
        });

        // Render rows
        if (tableBody) {
            tableBody.innerHTML = ''; // Clear table
            if (filteredAndSortedRows.length === 0) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.innerHTML = `<td colspan="7" class="text-center text-muted">No warnings found matching your criteria.</td>`;
                tableBody.appendChild(noResultsRow);
            } else {
                filteredAndSortedRows.forEach(warning => {
                    tableBody.appendChild(warning.element); // Append the actual DOM element
                    warning.element.style.display = ''; // Ensure it's visible
                });
            }
        }
    }

    // Event Listeners for filters
    filterStaff.addEventListener('change', applyFiltersAndSort);
    filterManager.addEventListener('change', applyFiltersAndSort);
    filterSeverity.addEventListener('change', applyFiltersAndSort);
    filterStatus.addEventListener('change', applyFiltersAndSort);

    clearFiltersBtn.addEventListener('click', function() {
        filterStaff.value = 'all';
        filterManager.value = 'all';
        filterSeverity.value = 'all';
        filterStatus.value = 'all';
        currentSortColumn = 'date_issued'; // Reset sort
        currentSortDirection = 'desc';     // Reset sort
        updateSortIcons();
        applyFiltersAndSort();
    });

    // Event Listeners for sortable headers
    document.querySelectorAll('#warningsTable th[data-sort-by]').forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            const sortBy = this.dataset.sortBy;
            if (currentSortColumn === sortBy) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = sortBy;
                currentSortDirection = 'asc'; // Default to ascending when changing column
            }
            updateSortIcons();
            applyFiltersAndSort();
        });
    });

    function updateSortIcons() {
        document.querySelectorAll('#warningsTable th[data-sort-by] i').forEach(icon => {
            icon.classList.remove('fa-sort-up', 'fa-sort-down');
            icon.classList.add('fa-sort'); // Reset all to default
        });

        const activeHeader = document.querySelector(`#warningsTable th[data-sort-by="${currentSortColumn}"] i`);
        if (activeHeader) {
            activeHeader.classList.remove('fa-sort');
            activeHeader.classList.add(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
        }
    }

    // Initial load
    updateSortIcons(); // Set initial sort icon
    applyFiltersAndSort(); // Apply filters and sort on page load
});
</script>
{% endblock scripts %}
{% endblock %}