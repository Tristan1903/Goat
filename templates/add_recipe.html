{% extends "base.html" %}

{% block title %}Add New Recipe{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body p-4 p-md-5">
                    <h2 class="card-title mb-2">Add a New Recipe</h2>
                    <p class="text-muted mb-4">Fill out the details for the new cocktail recipe and its ingredients.</p>
                    <form action="{{ url_for('add_recipe') }}" method="POST">
                        <div class="mb-3">
                            <label for="name" class="form-label">Recipe Name</label>
                            <input type="text" id="name" name="name" class="form-control" required value="{{ request.form.name }}"> {# Retain value on error #}
                        </div>
                        
                        {# --- NEW INGREDIENT MANAGEMENT SECTION --- #}
                        <h5 class="mt-4 mb-3">Ingredients</h5>
                        <div id="ingredients-container">
                            {# Initial blank ingredient row - REMOVED <select> #}
                            <div class="d-flex mb-2 ingredient-row align-items-center">
                                <div class="ingredient-dropdown-wrapper flex-grow-1 me-2 position-relative">
                                    <input type="text" class="form-control ingredient-search-input" placeholder="Ingredient" aria-label="Search ingredient" required>
                                    <input type="hidden" name="ingredient_id[]" class="selected-ingredient-id">
                                    <div class="ingredient-options-list list-group position-absolute w-100 shadow-sm" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;">
                                        {# Options will be dynamically added here #}
                                    </div>
                                </div>
                                <input type="number" step="0.01" min="0" class="form-control quantity-input me-2" name="quantity[]" placeholder="Quantity" required>
                                <button type="button" class="btn btn-outline-danger remove-ingredient"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline-secondary btn-sm mt-2"><i class="fas fa-plus"></i> Add Another Ingredient</button>
                        {# --- END NEW INGREDIENT MANAGEMENT SECTION --- #}

                        <div class="mb-3 mt-4">
                            <label for="instructions" class="form-label">Instructions</label>
                            <textarea id="instructions" name="instructions" class="form-control" rows="6" required placeholder="e.g.,&#10;1. Add all ingredients to a shaker with ice.&#10;2. Shake well until chilled.&#10;3. Strain into a salt-rimmed glass.">{{ request.form.instructions }}</textarea> {# Retain value on error #}
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{{ url_for('recipes') }}" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Recipe</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ingredientsContainer = document.getElementById('ingredients-container');
    const addIngredientBtn = document.getElementById('add-ingredient-btn');

    // Store all products as a JS array from Jinja for client-side filtering
    const allProducts = [
        {% for product in products %}
            { id: "{{ product.id }}", name: "{{ product.name }}", unit: "{{ product.unit_of_measure }}" },
        {% endfor %}
    ];

    // Helper to get selected product IDs across all rows (for disabling already-used options)
    function getSelectedProductIds() {
        return Array.from(ingredientsContainer.querySelectorAll('.selected-ingredient-id'))
            .map(input => input.value)
            .filter(value => value && value !== '');
    }

    // Function to render options list for a given input
    function renderOptionsList(inputElement, filterTerm = '') {
        const wrapper = inputElement.closest('.ingredient-dropdown-wrapper');
        const optionsList = wrapper.querySelector('.ingredient-options-list');
        const selectedIdInput = wrapper.querySelector('.selected-ingredient-id');
        const currentlySelectedId = selectedIdInput.value;

        optionsList.innerHTML = ''; // Clear previous options
        optionsList.style.display = 'none'; // CRITICAL FIX 1: Hide by default

        const selectedProductIds = getSelectedProductIds(); // Get all selected IDs from other rows

        const filtered = allProducts.filter(product => {
            const lowerCaseName = product.name.toLowerCase();
            const lowerCaseUnit = product.unit.toLowerCase();
            const lowerCaseFilter = filterTerm.toLowerCase();

            const isMatch = lowerCaseName.includes(lowerCaseFilter) || lowerCaseUnit.includes(lowerCaseFilter);
            const isAlreadySelected = selectedProductIds.includes(product.id) && product.id !== currentlySelectedId; // Exclude self if already selected

            return isMatch && !isAlreadySelected;
        }).sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically

        if (filtered.length === 0 && filterTerm) {
             const noResults = document.createElement('div');
             noResults.className = 'list-group-item disabled text-muted';
             noResults.textContent = 'No matching products';
             optionsList.appendChild(noResults);
             optionsList.style.display = 'block';
             return;
        } else if (filtered.length === 0 && !filterTerm && !currentlySelectedId) {
            // No results and no search term means nothing to show, hide list
            return;
        }

        filtered.forEach(product => {
            const item = document.createElement('button');
            item.type = 'button'; // Important for semantic button behavior without form submission
            item.className = 'list-group-item list-group-item-action';
            item.dataset.productId = product.id;
            item.textContent = `${product.name} (${product.unit})`;
            
            item.addEventListener('click', () => {
                inputElement.value = product.name;
                selectedIdInput.value = product.id;
                optionsList.style.display = 'none'; // CRITICAL FIX 2: Close dropdown on selection
                // Trigger change to update other dropdowns' disabled states
                inputElement.dispatchEvent(new Event('change', { bubbles: true }));
            });
            optionsList.appendChild(item);
        });

        // Only show list if there are actual items or 'no matching products'
        if (filtered.length > 0 || filterTerm) {
            optionsList.style.display = 'block';
        }
    }

    // Function to set up event listeners for a new ingredient row
    function setupIngredientRowListeners(row) {
        const searchInput = row.querySelector('.ingredient-search-input');
        const selectedIdInput = row.querySelector('.selected-ingredient-id');
        const optionsList = row.querySelector('.ingredient-options-list');

        let blurTimeout;

        searchInput.addEventListener('focus', () => {
            clearTimeout(blurTimeout);
            // Only render options if input is not empty or if it's currently selected
            if (searchInput.value || selectedIdInput.value) {
                renderOptionsList(searchInput, searchInput.value);
            }
        });

        searchInput.addEventListener('input', () => {
            selectedIdInput.value = ''; // Clear selected ID if user starts typing
            renderOptionsList(searchInput, searchInput.value);
        });

        // Handle blur with a small delay to allow click event on options to fire
        searchInput.addEventListener('blur', () => {
            blurTimeout = setTimeout(() => {
                optionsList.style.display = 'none';
                // If input value is empty and no selection, ensure hidden ID is cleared
                if (!searchInput.value && !selectedIdInput.value) {
                    selectedIdInput.value = '';
                } else if (searchInput.value && !selectedIdInput.value) {
                    // If user typed something but didn't select, clear the input as well
                    // to ensure only selected items are submitted
                    searchInput.value = '';
                }
            }, 100); 
        });

        // Ensure clicks within the options list don't immediately hide it due to blur
        optionsList.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Prevent blur from firing on input when clicking option
        });

        // Custom change event handler for searchInput (simulated for refreshAllIngredientRowsOptions)
        // This is called when an item is selected from the list.
        searchInput.addEventListener('change', (e) => {
            refreshAllIngredientRowsOptions();
        });
        
        // When quantity changes, also refresh to catch any indirect impacts
        row.querySelector('.quantity-input').addEventListener('input', () => {
             refreshAllIngredientRowsOptions();
        });
    }

    // Refreshes all ingredient rows' option lists based on current selections
    function refreshAllIngredientRowsOptions() {
        ingredientsContainer.querySelectorAll('.ingredient-row').forEach(row => {
            const searchInput = row.querySelector('.ingredient-search-input');
            // Only re-render if the list is currently visible or the input is focused
            if (searchInput === document.activeElement || row.querySelector('.ingredient-options-list').style.display === 'block') {
                renderOptionsList(searchInput, searchInput.value);
            }
        });
    }

    function addIngredientRow(initialProductId = '', initialQuantity = '', initialProductName = '') {
        const newRow = document.createElement('div');
        newRow.className = 'd-flex mb-2 ingredient-row align-items-center';
        newRow.innerHTML = `
            <div class="ingredient-dropdown-wrapper flex-grow-1 me-2 position-relative">
                <input type="text" class="form-control ingredient-search-input" placeholder="Type to search ingredient..." aria-label="Search ingredient" required>
                <input type="hidden" name="ingredient_id[]" class="selected-ingredient-id">
                <div class="ingredient-options-list list-group position-absolute w-100 shadow-sm" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;">
                </div>
            </div>
            <input type="number" step="0.01" min="0" class="form-control quantity-input me-2" name="quantity[]" placeholder="Quantity" required value="${initialQuantity}">
            <button type="button" class="btn btn-outline-danger remove-ingredient"><i class="fas fa-trash"></i></button>
        `;
        ingredientsContainer.appendChild(newRow);

        const searchInput = newRow.querySelector('.ingredient-search-input');
        const selectedIdInput = newRow.querySelector('.selected-ingredient-id');

        if (initialProductId && initialProductName) {
            searchInput.value = initialProductName;
            selectedIdInput.value = initialProductId;
        } else if (initialProductId) {
            const product = allProducts.find(p => p.id === initialProductId);
            if (product) {
                searchInput.value = product.name;
                selectedIdInput.value = product.id;
            }
        }

        setupIngredientRowListeners(newRow);
        refreshAllIngredientRowsOptions();
    }

    // --- LOGIC FOR INITIAL SETUP AND RESTORING FORM DATA ---
    const oldIngredients = {{ request.form.getlist('ingredient_id[]') | tojson | safe }};
    const oldQuantities = {{ request.form.getlist('quantity[]') | tojson | safe }};

    if (oldIngredients.length > 0) {
        ingredientsContainer.innerHTML = '';
        oldIngredients.forEach((id, index) => {
            const product = allProducts.find(p => p.id === id);
            addIngredientRow(id, oldQuantities[index] || '', product ? product.name : '');
        });
    } else {
        if (ingredientsContainer.children.length === 0) {
            addIngredientRow();
        }
    }
    // No initial refreshAllIngredientRowsOptions call here to prevent all dropdowns opening
    // They will open on focus/input
    // --- END LOGIC ---

    if (addIngredientBtn) {
        addIngredientBtn.addEventListener('click', () => addIngredientRow());
    }

    ingredientsContainer.addEventListener('click', function(event) {
        if (event.target.closest('.remove-ingredient')) {
            const rowToRemove = event.target.closest('.ingredient-row');
            if (!rowToRemove) return;

            if (ingredientsContainer.children.length > 1) { 
                rowToRemove.remove();
            } else {
                const searchInput = rowToRemove.querySelector('.ingredient-search-input');
                const selectedIdInput = rowToRemove.querySelector('.selected-ingredient-id');
                const quantityInput = rowToRemove.querySelector('.quantity-input');
                const optionsList = rowToRemove.querySelector('.ingredient-options-list');

                searchInput.value = '';
                selectedIdInput.value = '';
                quantityInput.value = '';
                optionsList.style.display = 'none';
            }
            refreshAllIngredientRowsOptions();
        }
    });

    // Initial setup for existing rows on page load (if any)
    ingredientsContainer.querySelectorAll('.ingredient-row').forEach(setupIngredientRowListeners);
});
</script>
{% endblock scripts %}
{% endblock %}